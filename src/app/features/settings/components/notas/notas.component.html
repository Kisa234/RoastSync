<div class="fixed inset-0 bg-black/30 backdrop-blur-md flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-2xl shadow-xl p-8
              w-[95vw] sm:max-w-2xl md:max-w-3xl lg:max-w-5xl xl:max-w-6xl
              max-h-[85vh] overflow-hidden relative">

    <lucide-icon [img]="X"
      class="absolute top-1 right-1 w-5 h-5 cursor-pointer text-gray-400 hover:text-gray-600"
      (click)="onClose()" />

    <div class="flex flex-col gap-4">

      <!-- Header / acciones -->
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div class="text-xl font-semibold">Notas</div>

        <div class="flex items-center gap-2">
          <input type="text" [(ngModel)]="query" (ngModelChange)="applyFilter()" placeholder="Buscar nota..."
                 class="rounded-lg border px-3 py-2 text-sm" />

          <button class="inline-flex items-center gap-2 rounded-xl border px-3 py-2 text-sm hover:bg-gray-50"
                  (click)="startCreate(null)" title="Nueva nota raíz">
            <lucide-icon [img]="plus" class="w-4 h-4"></lucide-icon>
            Nueva nota
          </button>
        </div>
      </div>

      <!-- Contenido -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">

        <!-- Árbol / lista -->
        <div class="lg:col-span-2 rounded-2xl border bg-white overflow-hidden">
          <!-- header del card -->
          <div class="border-b px-4 py-2 text-sm text-gray-600">
            {{ loading ? 'Cargando...' : (visible.length + ' notas') }}
          </div>

          <!-- scroller: hermano del header, no dentro -->
          <div class="max-h-[72vh] overflow-auto">
            <ul class="divide-y">
              <li *ngFor="let row of visible; trackBy: trackById" class="px-3 py-2">
                <div class="flex items-center justify-between">
                  <div class="flex items-center gap-2" [style.paddingLeft.px]="row.depth * 16">
                    <!-- toggle / indicador -->
                    <button
                      class="w-6 h-6 inline-flex items-center justify-center rounded hover:bg-gray-100"
                      (click)="toggle(row)" *ngIf="row.hasChildren; else dot" title="Expandir/Contraer">
                      <lucide-icon [img]="chevronDown" *ngIf="expanded[row.id]" class="w-4 h-4"></lucide-icon>
                      <lucide-icon [img]="chevronRight" *ngIf="!expanded[row.id]" class="w-4 h-4"></lucide-icon>
                    </button>
                    <ng-template #dot>
                      <span class="w-2 h-2 rounded-full inline-block" [style.background]="row.color"></span>
                    </ng-template>

                    <!-- color + nombre -->
                    <span class="w-3 h-3 rounded-full border" [style.background]="row.color"></span>
                    <span class="font-medium">{{ row.name }}</span>
                    <span *ngIf="row.hasChildren" class="text-xs text-gray-500 ml-1">· {{ getChildCount(row.id) }} hijos</span>
                  </div>

                  <div class="flex items-center gap-1">
                    <button class="p-1 rounded hover:bg-gray-100" (click)="addChild(row)" title="Agregar hijo">
                      <lucide-icon [img]="folderPlus" class="w-4 h-4"></lucide-icon>
                    </button>
                    <button class="p-1 rounded hover:bg-gray-100" (click)="startEditById(row.id)" title="Editar">
                      <lucide-icon [img]="pencil" class="w-4 h-4"></lucide-icon>
                    </button>
                    <button class="p-1 rounded hover:bg-red-50 text-red-600" (click)="remove(row)" title="Eliminar">
                      <lucide-icon [img]="trash2" class="w-4 h-4"></lucide-icon>
                    </button>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div> <!-- 🔚 cierra el card de la lista -->

        <!-- Formulario (card separado) -->
        <div class="rounded-2xl border bg-white p-4 overflow-hidden">
          <div class="flex items-center justify-between">
            <div class="font-semibold">
              {{ editingId ? 'Editar nota' : (form.parentId ? 'Nueva nota hija' : 'Nueva nota') }}
            </div>
          </div>

          <!-- scroller interno del form -->
          <div class="mt-4 grid gap-3 max-h-[72vh] overflow-auto pr-2">
            <label class="text-sm">
              <span class="block text-gray-600 mb-1">Nombre</span>
              <input type="text" [(ngModel)]="form.name" class="w-full rounded-lg border px-3 py-2"
                     placeholder="Nombre de la nota" />
            </label>

            <label class="text-sm">
              <span class="block text-gray-600 mb-1">Color</span>
              <div class="flex items-center gap-3">
                <input type="color" [(ngModel)]="form.color" class="h-9 w-16 border rounded" />
                <span class="inline-flex items-center gap-2 text-xs text-gray-600">
                  Actual:
                  <span class="w-4 h-4 rounded-full border" [style.background]="form.color"></span>
                  {{ form.color }}
                </span>
              </div>
            </label>

            <label class="text-sm">
              <span class="block text-gray-600 mb-1">Padre</span>
              <select [(ngModel)]="form.parentId" class="w-full rounded-lg border px-3 py-2">
                <option [ngValue]="null">— (Raíz)</option>
                <option *ngFor="let n of notas" [ngValue]="n.id">{{ n.name }}</option>
              </select>
            </label>

            <div class="flex items-center gap-2 pt-2">
              <button class="rounded-xl bg-black text-white px-3 py-2 text-sm disabled:opacity-50"
                      (click)="save()" [disabled]="!form.name.trim()">
                {{ editingId ? 'Guardar cambios' : 'Crear nota' }}
              </button>
              <button class="rounded-xl border px-3 py-2 text-sm" (click)="cancelForm()">Limpiar</button>
            </div>
          </div>
        </div>

      </div>
    </div>

  </div>
</div>
