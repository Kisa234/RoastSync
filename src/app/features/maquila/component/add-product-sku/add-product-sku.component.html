<div class="fixed inset-0 bg-black/30 backdrop-blur-md flex items-center justify-center z-50 p-4">
  <div class="bg-white rounded-lg shadow-lg w-full max-w-xl overflow-visible">

    <!-- Header -->
    <div class="flex justify-between items-start px-6 pt-4">
      <div>
        <h2 class="text-xl font-semibold text-[#1F1F1F]">Empaquetar (crear/actualizar SKU)</h2>
        <p class="text-gray-600 text-sm">Selecciona el producto, el lote tostado y define la variante</p>
      </div>
      <button (click)="onCancel()" class="text-gray-400 hover:text-gray-600">
        <lucide-icon [img]="X" class="w-5 h-5"></lucide-icon>
      </button>
    </div>

    <!-- Error -->
    <div *ngIf="error" class="mx-6 mt-3 px-3 py-2 rounded border border-red-200 bg-red-50 text-red-700 text-sm">
      {{ error }}
    </div>

    <!-- Body -->
    <div class="px-6 py-5">
      <form class="grid grid-cols-2 gap-x-6 gap-y-4">

        <!-- Producto -->
        <div class="col-span-2">
          <label class="block text-gray-700 text-sm mb-1">Producto *</label>
          <select-search
            name="producto"
            [(ngModel)]="model.id_producto"
            [items]="productos"
            displayField="nombre"
            valueField="id_producto"
            placeholder="Buscar producto"
            (ngModelChange)="onProductoChange($event)">
          </select-search>
        </div>

        <!-- Lote Tostado -->
        <div class="col-span-2">
          <label class="block text-gray-700 text-sm mb-1">Lote Tostado *</label>
          <select-search
            name="lote"
            [(ngModel)]="model.id_lote_tostado"
            [items]="lotesTostados"
            displayField="id_lote_tostado"
            valueField="id_lote_tostado"
            placeholder="Seleccionar lote tostado"
            (ngModelChange)="onLoteChange($event)">
          </select-search>
          <div *ngIf="selectedLote" class="mt-1 text-xs text-gray-500">
            Tostado: {{ selectedLote?.fecha_tostado | date:'dd/MM/yyyy' }} · Perfil: {{ selectedLote?.perfil_tostado }}
            <span *ngIf="selectedLote?.peso">&nbsp;· Peso (kg): {{ selectedLote?.peso }}</span>
          </div>
        </div>

        <!-- Gramaje -->
        <div class="col-span-2 sm:col-span-1">
          <label class="block text-gray-700 text-sm mb-1">Gramaje (g) *</label>
          <input
            type="number"
            min="1"
            step="1"
            [(ngModel)]="model.gramaje"
            name="gramaje"
            (ngModelChange)="recalc()"
            class="w-full border border-[#E5E5E5] rounded px-3 py-2" />
        </div>

        <!-- Molienda -->
        <div class="col-span-2 sm:col-span-1">
          <label class="block text-gray-700 text-sm mb-1">Molienda *</label>
          <select
            [(ngModel)]="model.molienda"
            name="molienda"
            (ngModelChange)="recalc()"
            class="w-full border border-[#E5E5E5] rounded px-3 py-2">
            <option [ngValue]="'ENTERO'">ENTERO</option>
            <option [ngValue]="'MOLIDO'">MOLIDO</option>
          </select>
        </div>

        <!-- Bolsas -->
        <div class="col-span-2 sm:col-span-1">
          <label class="block text-gray-700 text-sm mb-1">Bolsas (unidades) *</label>
          <input
            type="number"
            min="1"
            step="1"
            [(ngModel)]="model.cantidad"
            name="cantidad"
            (ngModelChange)="recalc()"
            class="w-full border border-[#E5E5E5] rounded px-3 py-2" />
        </div>

        <!-- Preview -->
        <div class="col-span-2 sm:col-span-1">
          <label class="block text-gray-700 text-sm mb-1">Resumen</label>
          <div class="w-full border border-[#E5E5E5] rounded px-3 py-2 bg-gray-50">
            <div class="text-sm text-gray-700">SKU: <span class="font-mono">{{ previewSku }}</span></div>
            <div class="text-sm text-gray-700">Peso total (gr): <span class="font-semibold">{{ pesoTotalGr }}</span></div>
          </div>
        </div>

      </form>
    </div>

    <!-- Footer -->
    <div class="flex justify-end items-center px-6 py-4 border-t border-[#E5E5E5] space-x-2">
      <button (click)="onCancel()" class="px-4 py-2 rounded border border-[#A67C52] hover:bg-[#F3F2F1]">
        Cancelar
      </button>
      <button
        (click)="save()"
        class="px-4 py-2 rounded bg-[#B8672E] text-white hover:bg-[#A67C52] flex items-center disabled:opacity-50"
        [disabled]="saving || !canSave()">
        <lucide-icon [img]="Check" class="w-5 h-5 mr-2"></lucide-icon>
        Guardar
      </button>
    </div>

  </div>
</div>
